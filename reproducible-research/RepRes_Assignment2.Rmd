# Assessment of economic and population impact of weather events using the NOAA Storm Database

```{r, echo = FALSE}
library(dplyr, warn.conflicts = FALSE)
library(ggplot2, warn.conflicts = FALSE)
library(RColorBrewer, warn.conflicts = FALSE)
library(reshape2, warn.conflicts = FALSE)
library(scales, warn.conflicts = FALSE)

cfile <- "./repdata-data-StormData.csv.bz2"
bfile <- "./repdata-data-StormData.rds"
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
```

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

The U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

This article aims at addressing two questions about weather events that happened in the US: a) "which ones are most harmful with respect to population health?"; and b) "which ones have the greatest economic consequences?".

The analysis of the NOAA Storm Database allowed us to conclude that...

## Data Processing

The dataset is available [here](`r url`) in the form of a comma-separated-value file, compressed via the bzip2 algorithm to reduce its size.

The dataset is downloaded from the aforementioned website in the working directory and read into the `noaa` variable. For purposes of accelerating the generation of this report, the original file is parsed with `read.table` if no **`r bfile`** exists. The reason is that using a binary format provides better performance and smaller size.

```{r}
if (!file.exists(bfile)) {
    if (!file.exists(cfile)) {
        download.file(url = url, destfile = cfile, method = "curl")
    }
    csv <- read.table(bzfile(cfile), header = TRUE, stringsAsFactors = TRUE, na.strings = "NA", sep = ",", quote = "\"")
    saveRDS(csv, bfile)
}
noaa <- readRDS(bfile)
```

In what follows, we will develop and present the code necessary to address the questions that were previously listed.

#### Q1 -- Across the United States, which types of events are most harmful with respect to population health?

```{r}
event_types <- levels(noaa$EVTYPE)
```

According to the [storm data documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf), the `EVTYPE` variable denotes the types of weather events that happened across the United States. In this article, we will take into consideration the sum of the number of fatalities (`noaa$FATALITIES`) and the number of injuries (`noaa$INJURIES`) as a means to order which events were most harmful with respect to population health. Since there are `r length(event_types)` distinct types of events in the database, we will take the first 20 most harmful events.

```{r}
noaa_health_impact <- noaa %>%
                          select(EVTYPE, FATALITIES, INJURIES) %>%
                          group_by(type = EVTYPE) %>% 
                          summarise(fatalities = sum(FATALITIES), injuries = sum(INJURIES)) %>%
                          arrange(desc(fatalities, injuries)) %>%
                          slice(1:20) %>%
                          mutate(type = factor(type, rev(as.character(type))))
noaa_health_impact
```

#### Q2 -- Across the United States, which types of events have the greatest economic consequences?

Estimate economic consequences were measured in dollars (`noaa$PROPDMG` and `noaa$CROPDMG`), and its value rounded to three significant digits, followed by an alphabetical character signifying the magnitude of the number (`noaa$PROPDMGEXP` and `noaa$CROPDMGEXP`), i.e., 1.55B for $1,550,000,000. Alphabetical characters used to signify magnitude include "K" for thousands, "M" for millions, and "B" for billions. In order to get an accurate value, these tuples(`DMG, DMGEXP`) must be decoded and converted into plain values. The task is performed by `value_calc` function (which does the calculation), and `damage_calc` (which sums the two kinds of damages).

```{r}
damage_calc <- function(row) {
    prop <- value_calc(as.numeric(row["PROPDMG"]), as.character(row["PROPDMGEXP"]))
    crop <- value_calc(as.numeric(row["CROPDMG"]), as.character(row["CROPDMGEXP"]))
    return(prop + crop)
}

value_calc <- function(number = 0, exp = "") {
    if (exp %in% c("", "-", "?", "+")) return(number)
    if (exp %in% c("H", "h")) return(number * 10^2)
    if (exp %in% c("k", "K")) return(number * 10^3)
    if (exp %in% c("m", "M")) return(number * 10^6)
    if (exp %in% c("B", "b")) return(number * 10^9)
    return(number * 10^as.integer(exp))
}
noaa$DAMAGE <- apply(noaa, 1, damage_calc)
noaa_economic_impact <- noaa %>%
                            select(EVTYPE, DAMAGE) %>%
                            group_by(type = EVTYPE) %>% 
                            summarise(damage = sum(DAMAGE)) %>%
                            arrange(desc(damage)) %>%
                            slice(1:20) %>%
                            mutate(type = factor(type, rev(as.character(type))))
noaa_economic_impact
```


## Results

```{r}
ggplot(melt(noaa_health_impact, id.var = "type"), aes(x = type, y = value, fill = variable)) + geom_bar(stat = "identity") + coord_flip() + xlab("Severe Weather Event") + ylab("Health Impact (Fatalities + Injuries)") + ggtitle("Public Health Consequences") + scale_fill_manual(values = c("#FF0000", "#FF9912"), name ="Impact", labels=c("Fatalities", "Injuries"))

ggplot(noaa_economic_impact, aes(x = type, y = damage, fill = type)) + geom_bar(stat = "identity") + scale_fill_manual(values = colorRampPalette(brewer.pal(5,"YlOrRd"))(20)) + coord_flip() + scale_y_continuous(labels = comma) + xlab("Severe Weather Event") + ylab("Damages (US$)") + ggtitle("Economic Consequences") + guides(fill = FALSE)
```