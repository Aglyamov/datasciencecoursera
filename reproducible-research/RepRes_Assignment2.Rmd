# Assessment of economic and population impact of weather events using the NOAA Storm Database

```{r, echo = FALSE, warning = FALSE}
library(dplyr)
cfile <- "./repdata-data-StormData.csv.bz2"
bfile <- "./repdata-data-StormData.rds"
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
```

Storms and other severe weather events can cause both public health and economic problems for communities and municipalities. Many severe events can result in fatalities, injuries, and property damage, and preventing such outcomes to the extent possible is a key concern.

The U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

This article aims at addressing two questions about weather events that happened in the US: a) "which ones are most harmful with respect to population health?"; and b) "which ones have the greatest economic consequences?".

The analysis of the NOAA Storm Database allowed us to conclude that...

<!--
Immediately after the title, there should be a synopsis which describes and summarizes your analysis in at most 10 complete sentences.
-->

## Data Processing

The dataset is available [here](`r url`) in the form of a comma-separated-value file, compressed via the bzip2 algorithm to reduce its size.

The dataset is downloaded from the aforementioned website in the working directory and read into the `noaa` variable. For purposes of accelerating the generation of this report, the original file is parsed with `read.table` if no **`r bfile`** exists. The reason is that using a binary format provides better performance and smaller size.

```{r}
if (!file.exists(bfile)) {
    if (!file.exists(cfile)) {
        download.file(url = url, destfile = cfile, method = "curl")
    }
    csv <- read.table(bzfile(cfile), header = TRUE, stringsAsFactors = TRUE, na.strings = "NA", sep = ",", quote = "\"")
    saveRDS(csv, bfile)
}
noaa <- readRDS(bfile)
#noaa <- read.table("./head_open-repdata-data-StormData.csv", header = TRUE, stringsAsFactors = TRUE, sep = ",", quote = "\"")
```

In what follows, we will develop and present the code necessary to address the questions that were previously listed.

#### Q1 -- Across the United States, which types of events are most harmful with respect to population health?

```{r}
event_types <- levels(noaa$EVTYPE)
```

According to the [storm data documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf), the `EVTYPE` variable denotes the types of weather events that happened across the United States. In this article, we will take into consideration the sum of the number of fatalities (`noaa$FATALITIES`) and the number of injuries (`noaa$INJURIES`) as a means to order which events were most harmful with respect to population health. Since there are `r length(event_types)` distinct types of events in the database, we will take the first 20 most harmful events.

```{r}
noaa_health_impact <- noaa %>%
                          select(EVTYPE, FATALITIES, INJURIES) %>%
                          group_by(type = EVTYPE) %>% 
                          summarise(fatalities = sum(FATALITIES), injuries = sum(INJURIES)) %>%
                          arrange(desc(fatalities, injuries)) %>%
                          head(20)
noaa_health_impact
```

```{r}
damage_calc <- function(number, exp = "") {
    if (exp %in% c("", "-", "?", "+")) return(number)
    if (exp %in% c("H", "h")) return(number * 10^2)
    if (exp %in% c("k", "K")) return(number * 10^3)
    if (exp %in% c("m", "M")) return(number * 10^6)
    if (exp %in% c("B", "b")) return(number * 10^9)
    return(number * 10^exp)
}

levels(noaa$PROPDMGEXP) <- c(10^0, 10^0, 10^0, 10^0, 10^0, 10^1, 10^2, 10^3, 10^4, 10^5, 10^6, 10^7, 10^8, 10^9, 10^2, 10^2, 10^3, 10^6, 10^6)
levels(noaa$CROPDMGEXP) <- c(10^0, 10^0, 10^0, 10^2, 10^9, 10^3, 10^3, 10^6, 10^6)
noaa_economic_impact <- noaa %>%
                            select(EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP) %>%
                            mutate(damage = (PROPDMG * as.integer(PROPDMGEXP)) + (CROPDMG * as.integer(CROPDMGEXP))) %>%
                            group_by(type = EVTYPE) %>%
                            summarise(damage = sum(damage)) %>%
                            arrange(desc(damage)) %>%
                            head(20)
noaa_economic_impact
```

-->

## Results